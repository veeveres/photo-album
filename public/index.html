<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>Photo Album</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: #f5f5f7; color: #1d1d1f; }
.header { background: #fff; border-bottom: 1px solid #e5e5e5; padding: 12px 16px; display: flex; align-items: center; gap: 12px; position: sticky; top: 0; z-index: 100; }
.header h1 { font-size: 20px; font-weight: 600; white-space: nowrap; }
.header nav { display: flex; gap: 6px; margin-left: auto; }
.header nav button { padding: 8px 14px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; background: #e5e5e5; transition: all .2s; touch-action: manipulation; }
.header nav button.active { background: #0071e3; color: #fff; }
.container { max-width: 1200px; margin: 0 auto; padding: 16px; }

/* Upload zone */
.upload-zone { border: 2px dashed #c5c5c7; border-radius: 16px; padding: 32px 16px; text-align: center; cursor: pointer; transition: all .2s; background: #fff; margin-bottom: 20px; touch-action: manipulation; }
.upload-zone.drag { border-color: #0071e3; background: #f0f7ff; }
.upload-zone.has-selection { border-color: #34c759; border-style: solid; background: #f0fff4; cursor: default; }
.upload-zone h2 { font-size: 17px; margin-bottom: 6px; }
.upload-zone p { color: #86868b; font-size: 13px; }
.upload-zone .ios-tip { color: #86868b; font-size: 12px; margin-top: 8px; font-style: italic; }
.upload-zone input { display: none; }
.upload-zone .select-btn { display: inline-block; padding: 14px 32px; background: #0071e3; color: #fff; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; touch-action: manipulation; margin-bottom: 8px; min-height: 50px; }
@media (max-width: 599px) { .upload-zone .select-btn { width: 100%; padding: 16px; font-size: 18px; min-height: 56px; } }
.upload-zone .select-btn:active { background: #005bb5; }
.preview-section { display: none; margin-top: 16px; }
.preview-section.active { display: block; }
.preview-section .count { font-size: 18px; font-weight: 600; color: #1d1d1f; margin-bottom: 12px; }
.preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 4px; max-height: 200px; overflow-y: auto; margin-bottom: 12px; border-radius: 8px; }
.preview-grid img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 4px; }
.preview-grid .more { display: flex; align-items: center; justify-content: center; background: #e5e5e5; border-radius: 4px; aspect-ratio: 1; font-size: 13px; font-weight: 600; color: #555; }
.upload-actions { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
.upload-actions .upload-btn { padding: 14px 32px; background: #34c759; color: #fff; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; touch-action: manipulation; }
.upload-actions .upload-btn:active { background: #2da44e; }
.upload-actions .clear-btn { padding: 14px 24px; background: #e5e5e5; color: #333; border: none; border-radius: 12px; font-size: 14px; cursor: pointer; touch-action: manipulation; }
@media (max-width: 599px) { .upload-actions .upload-btn, .upload-actions .clear-btn { flex: 1; } }

/* Album delete button */
.album-card { position: relative; }
.album-card .album-delete-btn { position: absolute; top: 8px; right: 8px; background: rgba(255,59,48,.85); color: #fff; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 16px; line-height: 32px; text-align: center; touch-action: manipulation; z-index: 5; display: none; }
.album-card:hover .album-delete-btn { display: block; }
@media (hover: none) { .album-card .album-delete-btn { display: block; } }

/* Progress UI */
.batch-progress { background: #fff; border-radius: 12px; padding: 16px; margin-bottom: 20px; box-shadow: 0 1px 4px rgba(0,0,0,.06); display: none; }
.batch-progress.active { display: block; }
.batch-progress .progress-bar { background: #e5e5e5; border-radius: 6px; height: 8px; overflow: hidden; margin: 10px 0; }
.batch-progress .progress-fill { background: #0071e3; height: 100%; border-radius: 6px; transition: width .3s ease; width: 0%; }
.batch-progress .progress-text { font-size: 13px; color: #555; display: flex; justify-content: space-between; }
.batch-progress .status-label { font-size: 15px; font-weight: 600; }
.batch-progress.complete .progress-fill { background: #34c759; }

/* Grid */
.photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px; }
@media (min-width: 600px) { .photo-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; } }
.photo-card { background: #fff; border-radius: 12px; overflow: hidden; cursor: pointer; transition: transform .2s, box-shadow .2s; position: relative; }
.photo-card:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,.1); }
.photo-card:active { transform: scale(0.97); }
.photo-card img { width: 100%; aspect-ratio: 1; object-fit: cover; display: block; }
.photo-card .info { padding: 8px 10px; }
.photo-card .info .date { font-size: 11px; color: #86868b; }
.photo-card .info .location { font-size: 11px; color: #0071e3; margin-top: 2px; }
.photo-card .badge { position: absolute; top: 6px; right: 6px; background: rgba(0,0,0,.6); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 8px; max-width: 70%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* AI overlay on hover/tap */
.photo-card .ai-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,.85)); color: #fff; padding: 32px 10px 10px; opacity: 0; transition: opacity .25s; pointer-events: none; }
.photo-card:hover .ai-overlay, .photo-card .ai-overlay.tapped { opacity: 1; }
.photo-card .ai-overlay .ai-desc { font-size: 11px; line-height: 1.4; margin-bottom: 6px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
.photo-card .ai-overlay .ai-tags { display: flex; flex-wrap: wrap; gap: 3px; }
.tag-pill { display: inline-block; padding: 2px 7px; border-radius: 10px; font-size: 10px; font-weight: 500; }
.tag-beach, .tag-ocean, .tag-water, .tag-pool, .tag-sea { background: rgba(0,122,255,.8); color: #fff; }
.tag-family, .tag-people, .tag-portrait, .tag-couple, .tag-friends, .tag-group { background: rgba(255,149,0,.8); color: #fff; }
.tag-food, .tag-restaurant, .tag-cooking, .tag-meal, .tag-drink { background: rgba(52,199,89,.8); color: #fff; }
.tag-city, .tag-urban, .tag-street, .tag-architecture, .tag-building { background: rgba(142,142,147,.85); color: #fff; }
.tag-nature, .tag-garden, .tag-forest, .tag-mountain, .tag-tree, .tag-park, .tag-outdoor { background: rgba(48,176,80,.8); color: #fff; }
.tag-sunset, .tag-sunrise, .tag-night, .tag-sky { background: rgba(175,82,222,.8); color: #fff; }
.tag-animal, .tag-pet, .tag-dog, .tag-cat { background: rgba(255,204,0,.85); color: #333; }
.tag-default { background: rgba(255,255,255,.2); color: #fff; }
.photo-card .delete-btn { position: absolute; top: 6px; left: 6px; background: rgba(255,59,48,.85); color: #fff; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; display: none; font-size: 14px; line-height: 28px; text-align: center; touch-action: manipulation; }
.photo-card:hover .delete-btn { display: block; }
@media (hover: none) { .photo-card .delete-btn { display: block; } }
.photo-card .processing-badge { position: absolute; bottom: 40px; left: 0; right: 0; text-align: center; }
.photo-card .processing-badge span { background: rgba(0,113,227,.85); color: #fff; font-size: 10px; padding: 2px 8px; border-radius: 8px; }

/* Albums */
.album-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; }
@media (max-width: 599px) { .album-grid { grid-template-columns: 1fr; } }
.album-card { background: #fff; border-radius: 16px; overflow: hidden; cursor: pointer; transition: transform .2s; }
.album-card:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,.1); }
.album-card:active { transform: scale(0.98); }
.album-card .preview { display: grid; grid-template-columns: 1fr 1fr; height: 160px; }
.album-card .preview img { width: 100%; height: 100%; object-fit: cover; }
.album-card .preview .empty { background: #e5e5e5; display: flex; align-items: center; justify-content: center; color: #aaa; font-size: 32px; }
.album-card .meta { padding: 12px 14px; display: flex; justify-content: space-between; align-items: center; }
.album-card .meta h3 { font-size: 14px; font-weight: 600; }
.album-card .meta span { font-size: 12px; color: #86868b; }
.album-card .album-summary { padding: 0 14px 10px; font-size: 11px; color: #86868b; line-height: 1.4; }
.album-card .album-summary .album-tags { display: flex; flex-wrap: wrap; gap: 3px; margin-top: 4px; }

/* Album detail */
.album-detail { display: none; }
.album-detail .back { cursor: pointer; color: #0071e3; font-size: 14px; margin-bottom: 12px; display: inline-block; touch-action: manipulation; }
.album-detail h2 { font-size: 22px; margin-bottom: 4px; cursor: pointer; }
.album-detail h2:hover { text-decoration: underline; }
.album-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
.export-btn { padding: 8px 16px; background: #0071e3; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; touch-action: manipulation; }
.export-btn:active { background: #005bb5; }

/* Modal */
.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.85); z-index: 200; align-items: center; justify-content: center; padding: 16px; }
.modal-overlay.show { display: flex; }
.modal { background: #fff; border-radius: 16px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
.modal img { width: 100%; border-radius: 16px 16px 0 0; }
.modal .details { padding: 16px; }
.modal .details p { font-size: 14px; color: #555; margin-bottom: 6px; }
.modal .details .tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
.modal .details .tags span { background: #f0f0f0; padding: 4px 10px; border-radius: 12px; font-size: 12px; }
.modal .move-section { margin-top: 12px; padding-top: 12px; border-top: 1px solid #eee; }
.modal .move-section select { padding: 8px 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 14px; min-height: 44px; }
.close-modal { position: absolute; top: 16px; right: 16px; background: rgba(0,0,0,.6); color: #fff; border: none; border-radius: 50%; width: 36px; height: 36px; cursor: pointer; font-size: 18px; touch-action: manipulation; z-index: 10; }
.nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,.5); color: #fff; border: none; border-radius: 50%; width: 44px; height: 44px; cursor: pointer; font-size: 22px; z-index: 10; touch-action: manipulation; }
.nav-btn:hover { background: rgba(0,0,0,.75); }
.nav-prev { left: 12px; }
.nav-next { right: 12px; }
.modal .details .tags span.tag-pill { font-size: 12px; padding: 4px 10px; }

.hidden { display: none; }
.loading { text-align: center; padding: 48px; color: #86868b; }

/* New album button */
.new-album-btn { padding: 8px 16px; border: 1px solid #e5e5e5; border-radius: 8px; background: #fff; cursor: pointer; font-size: 13px; touch-action: manipulation; min-height: 44px; }

/* Book Viewer */
.book-viewer-overlay { display:none; position:fixed; inset:0; background:#fafafa; z-index:300; flex-direction:column; }
.book-viewer-overlay.show { display:flex; }
.book-topbar { display:flex; align-items:center; justify-content:space-between; padding:12px 20px; background:#fff; border-bottom:1px solid #e5e5e5; flex-shrink:0; }
.book-topbar h2 { font-size:17px; font-weight:300; letter-spacing:.5px; }
.book-topbar .book-close { background:none; border:none; font-size:28px; cursor:pointer; color:#333; padding:4px 8px; touch-action:manipulation; }
.book-topbar .book-page-ind { font-size:12px; color:#86868b; font-variant:small-caps; letter-spacing:1px; }
.book-topbar .book-pdf-btn { padding:6px 14px; background:#0071e3; color:#fff; border:none; border-radius:8px; cursor:pointer; font-size:13px; touch-action:manipulation; }
.book-stage { flex:1; display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative; perspective:1200px; }
.book-page { position:absolute; width:min(90vw,600px); max-height:85vh; background:#fff; border-radius:4px; box-shadow:0 2px 20px rgba(0,0,0,.08), 0 0 1px rgba(0,0,0,.1); padding:40px 36px; display:flex; flex-direction:column; align-items:center; justify-content:center; transition:transform .5s ease, opacity .4s ease; backface-visibility:hidden; transform-origin:center center; }
.book-page.current { transform:rotateY(0deg); opacity:1; z-index:2; }
.book-page.prev { transform:rotateY(-30deg) scale(.9); opacity:0; z-index:1; pointer-events:none; }
.book-page.next { transform:rotateY(30deg) scale(.9); opacity:0; z-index:1; pointer-events:none; }
.book-page.hidden { display:none; }
.book-page .page-num { position:absolute; bottom:14px; font-size:10px; color:#bbb; font-variant:small-caps; letter-spacing:1px; }

/* Book page layouts */
.book-cover { text-align:center; gap:20px; }
.book-cover img { max-width:80%; max-height:50vh; object-fit:contain; border-radius:4px; box-shadow:0 4px 24px rgba(0,0,0,.1); }
.book-cover .cover-title { font-size:26px; font-weight:300; letter-spacing:1px; margin-top:16px; }
.book-cover .cover-meta { font-size:11px; color:#86868b; font-variant:small-caps; letter-spacing:1.5px; margin-top:4px; }

.book-fullbleed { padding:0!important; overflow:hidden; }
.book-fullbleed img { width:100%; height:100%; object-fit:cover; border-radius:4px; }
.book-fullbleed .fb-caption { position:absolute; bottom:0; left:0; right:0; padding:20px 24px 16px; background:linear-gradient(transparent, rgba(0,0,0,.5)); color:#fff; font-size:12px; font-weight:300; letter-spacing:.3px; }

.book-twoup { flex-direction:row!important; gap:12px; padding:32px 24px!important; }
.book-twoup img { flex:1; max-width:48%; max-height:70vh; object-fit:contain; border-radius:3px; box-shadow:0 2px 12px rgba(0,0,0,.06); }
.book-twoup .twoup-captions { position:absolute; bottom:16px; left:24px; right:24px; display:flex; gap:12px; }
.book-twoup .twoup-captions span { flex:1; font-size:11px; color:#86868b; text-align:center; font-variant:small-caps; }

.book-feature { gap:12px; padding:28px 24px!important; }
.book-feature .feat-main { max-width:90%; max-height:50vh; object-fit:contain; border-radius:3px; box-shadow:0 2px 16px rgba(0,0,0,.08); }
.book-feature .feat-row { display:flex; gap:8px; margin-top:4px; }
.book-feature .feat-row img { flex:1; max-height:18vh; object-fit:cover; border-radius:3px; box-shadow:0 1px 6px rgba(0,0,0,.06); }
.book-feature .feat-caption { font-size:11px; color:#86868b; margin-top:8px; font-variant:small-caps; letter-spacing:.5px; }

.book-collage { display:grid!important; grid-template-columns:1fr 1fr; gap:8px; padding:28px 24px!important; }
.book-collage img { width:100%; aspect-ratio:1; object-fit:cover; border-radius:3px; box-shadow:0 1px 8px rgba(0,0,0,.06); }
.book-collage .collage-caption { grid-column:1/-1; font-size:11px; color:#86868b; text-align:center; font-variant:small-caps; margin-top:4px; }

.book-divider { text-align:center; gap:8px; }
.book-divider .divider-date { font-size:22px; font-weight:200; letter-spacing:2px; color:#333; }
.book-divider .divider-loc { font-size:12px; color:#86868b; font-variant:small-caps; letter-spacing:1.5px; }
.book-divider hr { width:40px; border:none; border-top:1px solid #ddd; margin:8px auto; }

.book-nav-btn { position:absolute; top:50%; transform:translateY(-50%); background:rgba(0,0,0,.04); border:none; border-radius:50%; width:48px; height:48px; cursor:pointer; font-size:24px; color:#666; z-index:5; touch-action:manipulation; transition:background .2s; }
.book-nav-btn:hover { background:rgba(0,0,0,.1); }
.book-nav-prev { left:12px; }
.book-nav-next { right:12px; }
@media(max-width:599px) { .book-nav-btn { display:none; } .book-page { width:96vw; padding:24px 16px; } }
</style>
</head>
<body>
<div class="header">
  <h1>üì∏ Photos</h1>
  <nav>
    <button class="active" onclick="showView('photos')">All</button>
    <button onclick="showView('albums')">Albums</button>
  </nav>
</div>

<div class="container">
  <div class="upload-zone" id="uploadZone">
    <label for="fileInput" class="select-btn" id="selectBtn" role="button" tabindex="0">üìÅ Select Photos</label>
    <p>Or drop files here ‚Ä¢ JPEG, PNG, HEIC, WebP</p>
    <p class="ios-tip">üí° Tip: In the iOS photo picker, tap ‚Ä¢‚Ä¢‚Ä¢ then <b>Select All</b> to grab an entire album</p>
    <input type="file" id="fileInput" multiple accept="image/jpeg,image/png,image/webp,image/gif,image/tiff,image/heic,image/heif,.jpg,.jpeg,.png,.webp,.gif,.tiff,.heic,.heif">
    <div class="preview-section" id="previewSection">
      <div class="count" id="selectionCount"></div>
      <div class="preview-grid" id="previewGrid"></div>
      <div class="upload-actions">
        <button class="clear-btn" onclick="clearSelection()">‚úï Clear selection</button>
        <button class="upload-btn" onclick="startUpload()">‚¨Ü Upload</button>
      </div>
    </div>
  </div>

  <div class="batch-progress" id="batchProgress">
    <div class="status-label" id="batchStatusLabel">Processing...</div>
    <div class="progress-bar"><div class="progress-fill" id="batchProgressFill"></div></div>
    <div class="progress-text">
      <span id="batchProgressText">0 / 0</span>
      <span id="batchProgressPct">0%</span>
    </div>
  </div>

  <div id="photosView">
    <div class="photo-grid" id="photoGrid"></div>
  </div>

  <div id="albumsView" class="hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px">
      <h2>Albums</h2>
      <button class="new-album-btn" onclick="createAlbum()">+ New Album</button>
    </div>
    <div class="album-grid" id="albumGrid"></div>
  </div>

  <div id="albumDetail" class="album-detail">
    <span class="back" onclick="showView('albums')">‚Üê Back to Albums</span>
    <div class="album-header">
      <h2 id="albumTitle" onclick="renameCurrentAlbum()"></h2>
      <button class="export-btn" onclick="openBookViewer()" style="background:#333">üìñ View Book</button>
      <button class="export-btn" onclick="exportAlbum()">üì¶ Download ZIP</button>
    </div>
    <div class="photo-grid" id="albumPhotoGrid"></div>
  </div>
</div>

<div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
  <button class="nav-btn nav-prev" onclick="event.stopPropagation();navPhoto(-1)">‚Äπ</button>
  <button class="nav-btn nav-next" onclick="event.stopPropagation();navPhoto(1)">‚Ä∫</button>
  <div class="modal" id="modal">
    <button class="close-modal" onclick="document.getElementById('modalOverlay').classList.remove('show')">‚úï</button>
    <img id="modalImg">
    <div class="details" id="modalDetails"></div>
  </div>
</div>

<div class="book-viewer-overlay" id="bookViewer">
  <div class="book-topbar">
    <button class="book-close" onclick="closeBookViewer()">‚úï</button>
    <h2 id="bookTitle"></h2>
    <span class="book-page-ind" id="bookPageInd"></span>
    <button class="book-pdf-btn" onclick="downloadBookPdf()">‚¨á PDF</button>
  </div>
  <div class="book-stage" id="bookStage">
    <button class="book-nav-btn book-nav-prev" onclick="bookNav(-1)">‚Äπ</button>
    <button class="book-nav-btn book-nav-next" onclick="bookNav(1)">‚Ä∫</button>
  </div>
</div>

<script>
let allPhotos = [], allAlbums = [], currentAlbumId = null, activeBatchId = null, batchSSE = null, currentPhotoId = null, currentPhotoList = [];

const tagColorMap = {beach:1,ocean:1,water:1,pool:1,sea:1,swimming:1,family:2,people:2,portrait:2,couple:2,friends:2,group:2,food:3,restaurant:3,cooking:3,meal:3,drink:3,city:4,urban:4,street:4,architecture:4,building:4,nature:5,garden:5,forest:5,mountain:5,tree:5,park:5,outdoor:5,sunset:6,sunrise:6,night:6,sky:6,animal:7,pet:7,dog:7,cat:7};
function tagPill(tag) {
  const t = tag.trim().toLowerCase();
  const keys = Object.keys(tagColorMap);
  const match = keys.find(k => t.includes(k));
  const cls = match ? `tag-${match}` : 'tag-default';
  return `<span class="tag-pill ${cls}">${esc(tag.trim())}</span>`;
}
function aiOverlayHtml(p) {
  if (!p.ai_description && !p.ai_tags) return '';
  let h = '<div class="ai-overlay" ontouchstart="this.classList.toggle(\'tapped\')">';
  if (p.ai_description) h += `<div class="ai-desc">${esc(p.ai_description)}</div>`;
  if (p.ai_tags) h += `<div class="ai-tags">${p.ai_tags.split(',').slice(0,5).map(tagPill).join('')}</div>`;
  return h + '</div>';
}

// Upload - two-step: select then upload
const zone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');
const selectBtn = document.getElementById('selectBtn');
let selectedFiles = null;

// label-for-input handles click natively on iOS; also add JS fallback
selectBtn.addEventListener('click', (e) => {
  // If label-for didn't trigger (some browsers), manually click input
  setTimeout(() => { if (!fileInput.matches(':focus')) fileInput.click(); }, 50);
});
selectBtn.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fileInput.click(); } });
zone.addEventListener('click', (e) => { if (!selectedFiles && e.target === zone) fileInput.click(); });
zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag'); });
zone.addEventListener('dragleave', () => zone.classList.remove('drag'));
zone.addEventListener('drop', e => { e.preventDefault(); zone.classList.remove('drag'); showSelection(e.dataTransfer.files); });
fileInput.addEventListener('change', e => { showSelection(e.target.files); });

function showSelection(files) {
  if (!files || !files.length) return;
  selectedFiles = files;
  const count = files.length;
  document.getElementById('selectionCount').textContent = `${count} photo${count > 1 ? 's' : ''} selected`;
  const grid = document.getElementById('previewGrid');
  grid.innerHTML = '';
  const show = Math.min(count, 20);
  for (let i = 0; i < show; i++) {
    const img = document.createElement('img');
    img.src = URL.createObjectURL(files[i]);
    grid.appendChild(img);
  }
  if (count > 20) {
    const more = document.createElement('div');
    more.className = 'more';
    more.textContent = `+${count - 20}`;
    grid.appendChild(more);
  }
  document.getElementById('previewSection').classList.add('active');
  zone.classList.add('has-selection');
  selectBtn.textContent = 'üìÅ Change selection';
}

function clearSelection() {
  selectedFiles = null;
  fileInput.value = '';
  document.getElementById('previewSection').classList.remove('active');
  zone.classList.remove('has-selection');
  selectBtn.textContent = 'üìÅ Select Photos';
  document.getElementById('previewGrid').innerHTML = '';
}

function startUpload() {
  if (!selectedFiles || !selectedFiles.length) return;
  const files = Array.from(selectedFiles);
  selectedFiles = null;
  document.getElementById('previewSection').classList.remove('active');
  zone.classList.remove('has-selection');
  selectBtn.textContent = 'üìÅ Select Photos';
  document.getElementById('previewGrid').innerHTML = '';
  uploadFiles(files);
}

async function uploadFiles(files) {
  if (!files.length) return;
  const total = files.length;
  const progressEl = document.getElementById('batchProgress');
  const fillEl = document.getElementById('batchProgressFill');
  const textEl = document.getElementById('batchProgressText');
  const pctEl = document.getElementById('batchProgressPct');
  const labelEl = document.getElementById('batchStatusLabel');

  progressEl.classList.add('active');
  progressEl.classList.remove('complete');
  labelEl.textContent = `Uploading ${total} photo${total > 1 ? 's' : ''}...`;
  fillEl.style.width = '0%';
  textEl.textContent = `0 / ${total}`;
  pctEl.textContent = '0%';

  const fd = new FormData();
  for (const f of files) fd.append('photos', f);

  try {
    // Upload with XHR for progress
    const xhr = new XMLHttpRequest();
    const uploadPromise = new Promise((resolve, reject) => {
      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable) {
          const pct = Math.round(e.loaded / e.total * 100);
          fillEl.style.width = pct + '%';
          pctEl.textContent = pct + '%';
          textEl.textContent = `Uploading... ${formatBytes(e.loaded)} / ${formatBytes(e.total)}`;
        }
      };
      xhr.onload = () => {
        if (xhr.status >= 200 && xhr.status < 300) {
          resolve(JSON.parse(xhr.responseText));
        } else {
          reject(new Error('Upload failed'));
        }
      };
      xhr.onerror = () => reject(new Error('Upload failed'));
    });

    xhr.open('POST', '/api/upload');
    xhr.send(fd);
    const data = await uploadPromise;

    if (data.batchId) {
      activeBatchId = data.batchId;
      labelEl.textContent = `Processing ${total} photo${total > 1 ? 's' : ''}...`;
      fillEl.style.width = '0%';
      watchBatch(data.batchId, total);
    }

    // Reload photos immediately to show thumbnails as they appear
    loadPhotos();
  } catch(e) {
    labelEl.textContent = '‚ùå Upload failed. Please try again.';
    setTimeout(() => progressEl.classList.remove('active'), 5000);
  }
}

function watchBatch(batchId, total) {
  const progressEl = document.getElementById('batchProgress');
  const fillEl = document.getElementById('batchProgressFill');
  const textEl = document.getElementById('batchProgressText');
  const pctEl = document.getElementById('batchProgressPct');
  const labelEl = document.getElementById('batchStatusLabel');

  // Try SSE first, fall back to polling
  if (typeof EventSource !== 'undefined') {
    if (batchSSE) batchSSE.close();
    batchSSE = new EventSource(`/api/batch/${batchId}/status`);
    batchSSE.onmessage = (e) => {
      const d = JSON.parse(e.data);
      updateBatchUI(d, total, fillEl, textEl, pctEl, labelEl, progressEl);
      if (d.complete) {
        batchSSE.close();
        batchSSE = null;
        loadPhotos();
        loadAlbums();
      }
    };
    batchSSE.onerror = () => {
      batchSSE.close();
      batchSSE = null;
      pollBatch(batchId, total);
    };
  } else {
    pollBatch(batchId, total);
  }
}

function pollBatch(batchId, total) {
  const progressEl = document.getElementById('batchProgress');
  const fillEl = document.getElementById('batchProgressFill');
  const textEl = document.getElementById('batchProgressText');
  const pctEl = document.getElementById('batchProgressPct');
  const labelEl = document.getElementById('batchStatusLabel');

  const iv = setInterval(async () => {
    try {
      const r = await fetch(`/api/batch/${batchId}/poll`);
      const d = await r.json();
      updateBatchUI(d, total, fillEl, textEl, pctEl, labelEl, progressEl);
      if (d.complete) {
        clearInterval(iv);
        loadPhotos();
        loadAlbums();
      }
    } catch(e) {}
  }, 1500);
}

function updateBatchUI(d, total, fillEl, textEl, pctEl, labelEl, progressEl) {
  const pct = Math.round(d.processed / d.total * 100);
  fillEl.style.width = pct + '%';
  pctEl.textContent = pct + '%';
  textEl.textContent = `${d.processed} / ${d.total} processed` + (d.failed > 0 ? ` (${d.failed} failed)` : '');
  labelEl.textContent = d.complete ? `‚úÖ All ${d.total} photos processed!` : `Processing ${d.processed}/${d.total}...`;
  if (d.complete) {
    progressEl.classList.add('complete');
    setTimeout(() => progressEl.classList.remove('active'), 4000);
    // Refresh to show final state
    loadPhotos();
    loadAlbums();
  }
}

function formatBytes(b) {
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b/1024).toFixed(1) + ' KB';
  return (b/1048576).toFixed(1) + ' MB';
}

async function loadPhotos() {
  const r = await fetch('/api/photos');
  allPhotos = await r.json();
  renderPhotos();
}

async function loadAlbums() {
  const r = await fetch('/api/albums');
  allAlbums = await r.json();
  renderAlbums();
}

function renderPhotos() {
  const grid = document.getElementById('photoGrid');
  if (!allPhotos.length) { grid.innerHTML = '<div class="loading">No photos yet. Upload some!</div>'; return; }
  grid.innerHTML = allPhotos.map(p => {
    const isProcessing = p.processing_status && p.processing_status !== 'complete' && p.processing_status !== 'error';
    return `
    <div class="photo-card" onclick="showPhoto(${p.id})">
      <button class="delete-btn" onclick="event.stopPropagation();deletePhoto(${p.id})">‚úï</button>
      ${p.album_name ? `<span class="badge">${esc(p.album_name)}</span>` : ''}
      <img src="/thumbnails/${p.thumbnail}" loading="lazy" alt="" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 1 1%22><rect fill=%22%23e5e5e5%22 width=%221%22 height=%221%22/></svg>'">
      ${aiOverlayHtml(p)}
      ${isProcessing ? `<div class="processing-badge"><span>‚è≥ ${p.processing_status}</span></div>` : ''}
      <div class="info">
        <div class="date">${p.date_taken ? new Date(p.date_taken).toLocaleDateString() : 'No date'}</div>
        ${p.location_name ? `<div class="location">üìç ${esc(p.location_name)}</div>` : ''}
      </div>
    </div>`;
  }).join('');
}

function renderAlbums() {
  const grid = document.getElementById('albumGrid');
  if (!allAlbums.length) { grid.innerHTML = '<div class="loading">No albums yet. Upload photos to auto-generate albums!</div>'; return; }
  grid.innerHTML = allAlbums.map(a => {
    const aPhotos = allPhotos.filter(p => p.album_id === a.id);
    const photos = aPhotos.slice(0, 4);
    const previews = Array.from({length: 4}, (_, i) => photos[i] ? `<img src="/thumbnails/${photos[i].thumbnail}" onerror="this.parentElement.innerHTML+='<div class=empty>+</div>';this.remove()">` : '<div class="empty">+</div>').join('');
    // Build summary
    let summary = '';
    if (aPhotos.length) {
      const parts = [];
      const locs = [...new Set(aPhotos.map(p => p.location_name).filter(Boolean))];
      if (locs.length) parts.push('üìç ' + locs.slice(0,2).join(', '));
      const dates = aPhotos.filter(p => p.date_taken).map(p => new Date(p.date_taken));
      if (dates.length) {
        const min = new Date(Math.min(...dates)), max = new Date(Math.max(...dates));
        const fmt = d => d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
        parts.push('üìÖ ' + fmt(min) + (max-min > 86400000 ? ' ‚Äì ' + fmt(max) : ''));
      }
      const allTags = aPhotos.flatMap(p => (p.ai_tags||'').split(',').map(t=>t.trim()).filter(Boolean));
      const freq = {}; allTags.forEach(t => freq[t] = (freq[t]||0)+1);
      const topTags = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,4).map(e=>e[0]);
      summary = `<div class="album-summary">${parts.join(' ‚Ä¢ ')}${topTags.length ? '<div class="album-tags">' + topTags.map(tagPill).join('') + '</div>' : ''}</div>`;
    }
    return `
      <div class="album-card" onclick="openAlbum(${a.id})">
        <button class="album-delete-btn" onclick="event.stopPropagation();deleteAlbum(${a.id},'${esc(a.name)}',${a.photo_count})">‚úï</button>
        <div class="preview">${previews}</div>
        <div class="meta">
          <h3>${esc(a.name)}</h3>
          <span>${a.photo_count} photos</span>
        </div>
        ${summary}
      </div>`;
  }).join('');
}

async function openAlbum(id) {
  currentAlbumId = id;
  const album = allAlbums.find(a => a.id === id);
  document.getElementById('albumTitle').textContent = album?.name || 'Album';
  document.getElementById('photosView').classList.add('hidden');
  document.getElementById('albumsView').classList.add('hidden');
  document.getElementById('albumDetail').style.display = 'block';
  document.querySelectorAll('.header nav button').forEach(b => b.classList.remove('active'));

  const r = await fetch(`/api/albums/${id}/photos`);
  const photos = await r.json();
  currentPhotoList = photos;
  const grid = document.getElementById('albumPhotoGrid');
  grid.innerHTML = photos.map(p => `
    <div class="photo-card" onclick="showPhoto(${p.id})">
      <button class="delete-btn" onclick="event.stopPropagation();deletePhoto(${p.id})">‚úï</button>
      <img src="/thumbnails/${p.thumbnail}" loading="lazy" alt="" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 1 1%22><rect fill=%22%23e5e5e5%22 width=%221%22 height=%221%22/></svg>'">
      ${aiOverlayHtml(p)}
      <div class="info">
        <div class="date">${p.date_taken ? new Date(p.date_taken).toLocaleDateString() : ''}</div>
        ${p.location_name ? `<div class="location">üìç ${esc(p.location_name)}</div>` : ''}
      </div>
    </div>
  `).join('');
}

function showView(view) {
  document.getElementById('photosView').classList.toggle('hidden', view !== 'photos');
  document.getElementById('albumsView').classList.toggle('hidden', view !== 'albums');
  document.getElementById('albumDetail').style.display = 'none';
  document.querySelectorAll('.header nav button').forEach((b, i) => b.classList.toggle('active', (i === 0 && view === 'photos') || (i === 1 && view === 'albums')));
  if (view === 'albums') loadAlbums();
  if (view === 'photos') loadPhotos();
}

function showPhoto(id) {
  const list = currentPhotoList.length ? currentPhotoList : allPhotos;
  const p = list.find(x => x.id === id) || allPhotos.find(x => x.id === id);
  if (!p) return;
  currentPhotoId = id;
  if (!currentPhotoList.length) currentPhotoList = allPhotos;
  document.getElementById('modalImg').src = `/uploads/${p.filename}`;
  let html = '';
  if (p.ai_description) html += `<p style="font-size:15px;margin-bottom:10px">${esc(p.ai_description)}</p>`;
  if (p.date_taken) html += `<p>üìÖ ${new Date(p.date_taken).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}</p>`;
  if (p.location_name) html += `<p>üìç ${esc(p.location_name)}</p>`;
  if (p.camera) html += `<p>üì∑ ${esc(p.camera)}</p>`;
  if (p.ai_tags) html += `<div class="tags">${p.ai_tags.split(',').map(t => tagPill(t)).join('')}</div>`;
  html += `<div class="move-section"><label>Move to album: </label><select onchange="movePhoto(${p.id}, this.value)"><option value="">‚Äî</option>${allAlbums.map(a => `<option value="${a.id}" ${p.album_id === a.id ? 'selected' : ''}>${esc(a.name)}</option>`).join('')}</select></div>`;
  document.getElementById('modalDetails').innerHTML = html;
  document.getElementById('modalOverlay').classList.add('show');
}

function navPhoto(dir) {
  const list = currentPhotoList.length ? currentPhotoList : allPhotos;
  const idx = list.findIndex(p => p.id === currentPhotoId);
  if (idx < 0) return;
  const next = idx + dir;
  if (next >= 0 && next < list.length) showPhoto(list[next].id);
}

function closeModal(e) { if (e.target === document.getElementById('modalOverlay')) document.getElementById('modalOverlay').classList.remove('show'); }

async function deletePhoto(id) {
  if (!confirm('Delete this photo?')) return;
  await fetch(`/api/photos/${id}`, { method: 'DELETE' });
  loadPhotos(); loadAlbums();
  if (currentAlbumId) openAlbum(currentAlbumId);
}

async function movePhoto(photoId, albumId) {
  await fetch(`/api/photos/${photoId}/move`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ album_id: albumId || null }) });
  loadPhotos(); loadAlbums();
}

async function renameCurrentAlbum() {
  const album = allAlbums.find(a => a.id === currentAlbumId);
  const name = prompt('Rename album:', album?.name);
  if (name && name.trim()) {
    await fetch(`/api/albums/${currentAlbumId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: name.trim() }) });
    document.getElementById('albumTitle').textContent = name.trim();
    loadAlbums();
  }
}

async function createAlbum() {
  const name = prompt('Album name:');
  if (name && name.trim()) {
    await fetch('/api/albums', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: name.trim() }) });
    loadAlbums();
  }
}

async function deleteAlbum(id, name, photoCount) {
  const msg = photoCount > 0
    ? `Delete album "${name}"?\n\n‚Ä¢ "OK" = delete album AND its ${photoCount} photos\n‚Ä¢ To keep photos (just remove album), type "keep" below:`
    : `Delete empty album "${name}"?`;
  const answer = prompt(msg, photoCount > 0 ? 'delete' : 'ok');
  if (!answer) return;
  const deletePhotos = photoCount > 0 && answer.toLowerCase() !== 'keep';
  await fetch(`/api/albums/${id}?deletePhotos=${deletePhotos}`, { method: 'DELETE' });
  loadPhotos(); loadAlbums();
  if (currentAlbumId === id) showView('albums');
}

function exportAlbum() {
  if (currentAlbumId) window.open(`/api/albums/${currentAlbumId}/export`);
}

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// Keyboard navigation for lightbox
document.addEventListener('keydown', e => {
  if (!document.getElementById('modalOverlay').classList.contains('show')) return;
  if (e.key === 'ArrowLeft') navPhoto(-1);
  else if (e.key === 'ArrowRight') navPhoto(1);
  else if (e.key === 'Escape') document.getElementById('modalOverlay').classList.remove('show');
});

// Reset photo list when switching views
const origShowView = showView;

// ‚îÄ‚îÄ‚îÄ Book Viewer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let bookPages = [], bookCurrentPage = 0;

async function openBookViewer() {
  if (!currentAlbumId) return;
  const album = allAlbums.find(a => a.id === currentAlbumId);
  document.getElementById('bookTitle').textContent = album?.name || 'Photo Book';
  document.getElementById('bookViewer').classList.add('show');
  document.getElementById('bookStage').querySelectorAll('.book-page').forEach(el => el.remove());

  try {
    const r = await fetch(`/api/albums/${currentAlbumId}/book`);
    const data = await r.json();
    bookPages = data.pages || [];
    bookCurrentPage = 0;
    renderBookPages();
    updateBookPage();
  } catch(e) { console.error('Book load error:', e); }
}

function renderBookPages() {
  const stage = document.getElementById('bookStage');
  stage.querySelectorAll('.book-page').forEach(el => el.remove());

  bookPages.forEach((page, i) => {
    const div = document.createElement('div');
    div.className = 'book-page hidden';
    div.dataset.index = i;

    if (page.type === 'cover') {
      div.classList.add('book-cover');
      div.innerHTML = `
        ${page.photo ? `<img src="/uploads/${page.photo.filename}" alt="">` : ''}
        <div class="cover-title">${esc(page.title || '')}</div>
        <div class="cover-meta">${esc(page.dateRange || '')}${page.location ? ' ¬∑ ' + esc(page.location) : ''}</div>
      `;
    } else if (page.type === 'fullbleed') {
      div.classList.add('book-fullbleed');
      const p = page.photos[0];
      div.innerHTML = `<img src="/uploads/${p.filename}" alt=""><div class="fb-caption">${esc(p.caption || '')}</div>`;
    } else if (page.type === 'twoup') {
      div.classList.add('book-twoup');
      div.innerHTML = page.photos.map(p => `<img src="/uploads/${p.filename}" alt="">`).join('') +
        `<div class="twoup-captions">${page.photos.map(p => `<span>${esc(p.caption || '')}</span>`).join('')}</div>`;
    } else if (page.type === 'feature') {
      div.classList.add('book-feature');
      const [main, ...rest] = page.photos;
      div.innerHTML = `<img class="feat-main" src="/uploads/${main.filename}" alt="">
        <div class="feat-row">${rest.map(p => `<img src="/uploads/${p.filename}" alt="">`).join('')}</div>
        <div class="feat-caption">${esc(page.caption || '')}</div>`;
    } else if (page.type === 'collage') {
      div.classList.add('book-collage');
      div.innerHTML = page.photos.map(p => `<img src="/uploads/${p.filename}" alt="">`).join('') +
        `<div class="collage-caption">${esc(page.caption || '')}</div>`;
    } else if (page.type === 'divider') {
      div.classList.add('book-divider');
      div.innerHTML = `<div class="divider-date">${esc(page.date || '')}</div><hr>${page.location ? `<div class="divider-loc">${esc(page.location)}</div>` : ''}`;
    }

    if (page.type !== 'cover') {
      const pn = document.createElement('div');
      pn.className = 'page-num';
      pn.textContent = i;
      div.appendChild(pn);
    }

    stage.appendChild(div);
  });
}

function updateBookPage() {
  const pages = document.getElementById('bookStage').querySelectorAll('.book-page');
  pages.forEach((el, i) => {
    el.classList.remove('current', 'prev', 'next', 'hidden');
    if (i === bookCurrentPage) el.classList.add('current');
    else if (i === bookCurrentPage - 1) el.classList.add('prev');
    else if (i === bookCurrentPage + 1) el.classList.add('next');
    else el.classList.add('hidden');
  });
  document.getElementById('bookPageInd').textContent = `${bookCurrentPage + 1} / ${bookPages.length}`;
}

function bookNav(dir) {
  const n = bookCurrentPage + dir;
  if (n >= 0 && n < bookPages.length) { bookCurrentPage = n; updateBookPage(); }
}

function closeBookViewer() { document.getElementById('bookViewer').classList.remove('show'); }

function downloadBookPdf() {
  if (currentAlbumId) window.open(`/api/albums/${currentAlbumId}/book/pdf`);
}

// Swipe support for book
(function() {
  let sx = 0, sy = 0;
  const stage = document.getElementById('bookStage');
  stage.addEventListener('touchstart', e => { sx = e.touches[0].clientX; sy = e.touches[0].clientY; }, { passive: true });
  stage.addEventListener('touchend', e => {
    const dx = e.changedTouches[0].clientX - sx;
    const dy = e.changedTouches[0].clientY - sy;
    if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy)) bookNav(dx < 0 ? 1 : -1);
  }, { passive: true });
})();

// Keyboard for book viewer
document.addEventListener('keydown', e => {
  if (!document.getElementById('bookViewer').classList.contains('show')) return;
  if (e.key === 'ArrowLeft') bookNav(-1);
  else if (e.key === 'ArrowRight') bookNav(1);
  else if (e.key === 'Escape') closeBookViewer();
});

// Init
loadPhotos();
loadAlbums();
// Refresh periodically to pick up processing results
setInterval(() => { loadPhotos(); loadAlbums(); }, 10000);
</script>
</body>
</html>
